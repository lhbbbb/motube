{% extends 'base.html' %}

{% block body %}
<div id="app" class="mt-3">
  <h3>유튜브가 추천하는 영화</h3>
  <div class="row" v-infinite-scroll="loadMore" infinite-scroll-disabled="busy" infinite-scroll-distance="10">
    {% for movie in movies %}
    <div class="col-3">
      <div class="card" style="width: 18rem;">
        {% if user.is_authenticated %}
        <a href="{% url 'movies:detail' movie.pk %}"><img class="card-img-top" src="{{ movie.poster }}"
            alt="poster"></a>
        {% else %}
        <a href="{% url 'accounts:login' %}"><img class="card-img-top" src="{{ movie.poster }}" alt="poster"></a>
        {% endif %}
        <div class="card-body">
          <h5 class="card-title"><a href="{% url 'movies:detail' movie.pk %}">{{ movie.title }}</a></h5>
          {% if user.is_authenticated %}
          {% if user in movie.like_users.all %}
          <button @click="like({{ movie.pk }})" id="like{{ movie.pk }}" class="btn btn-outline-primary">좋아요 취소</button>
          {% else %}
          <button @click="like({{ movie.pk }})" id="like{{ movie.pk }}" class="btn btn-primary">좋아요</button>
          {% endif %}
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.0"></script>
<script src="https://unpkg.com/vue-infinite-scroll"></script>
<script>
  var count = 0;
  const app = new Vue({
    el: '#app',
    data: {
      data: [],
      busy: false
    },
    methods: {
      like(movieId) {
        const likeBtn = document.querySelector(`#like${movieId}`)
        axios.get(`/movies/${movieId}/like/`)
          .then(res => {
            if (res.data.liked) {
              likeBtn.className = 'btn btn-outline-primary'
              likeBtn.innerText = '좋아요 취소'
            } else {
              likeBtn.className = 'btn btn-primary'
              likeBtn.innerText = '좋아요'
            }
          })
      },
      loadMore: function () {
        this.busy = true;

        setTimeout(() => {
          for (var i = 0, j = 10; i < j; i++) {
            this.data.push({
              name: count++
            });
          }
          this.busy = false;
        }, 1000);
      }
    },
  })
</script>
{% endblock %}